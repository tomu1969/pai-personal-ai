<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAI Assistant - QR Code</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .title {
            color: #007bff;
            margin-bottom: 20px;
            font-size: 2em;
        }
        .qr-container {
            margin: 30px 0;
            padding: 20px;
            border: 2px dashed #007bff;
            border-radius: 8px;
            background: #f8f9ff;
        }
        #qr-image {
            max-width: 300px;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .instructions {
            text-align: left;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .warning {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 8px;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
        }
        .status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
        }
        .refresh-btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">ü§ñ PAI Assistant WhatsApp Line</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è IMPORTANT:</strong> Use a different WhatsApp account than your main line!
            <br>This could be WhatsApp Business, a different device, or a secondary account.
        </div>

        <div id="status-container">
            <div id="status" class="status connecting">
                üì∂ Checking connection status...
            </div>
        </div>

        <div class="qr-container">
            <h3>Scan this QR Code:</h3>
            <div id="qr-content">
                <div class="loading">üîÑ Loading QR Code...</div>
            </div>
        </div>

        <div class="instructions">
            <h4>üì± How to Connect:</h4>
            <ol>
                <li>Open WhatsApp on your PAI Assistant device</li>
                <li>Go to <strong>Settings</strong> ‚Üí <strong>Linked Devices</strong> (or WhatsApp Web)</li>
                <li>Tap <strong>"Link a Device"</strong></li>
                <li>Scan the QR code above</li>
                <li>Once connected, users can message this number with queries like:
                    <ul>
                        <li><em>"What messages did I get today?"</em></li>
                        <li><em>"Show me messages from John yesterday"</em></li>
                        <li><em>"Messages containing 'meeting' from this week"</em></li>
                    </ul>
                </li>
            </ol>
        </div>

        <button class="refresh-btn" onclick="alert('Button clicked!'); loadQRCode()">üîÑ Refresh QR Code</button>
        <button class="refresh-btn" onclick="alert('Status check!'); checkStatus()">üìä Check Status</button>
    </div>

    <script>
        let checkInterval;

        async function loadQRCode() {
            try {
                console.log('üîÑ Starting QR code load...');
                document.getElementById('qr-content').innerHTML = '<div class="loading">üîÑ Loading QR Code...</div>';
                
                console.log('üì° Fetching from /api/pai-assistant/qr...');
                const response = await fetch('/api/pai-assistant/qr');
                console.log('üì® Response status:', response.status, response.statusText);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ QR API Response received:', data);
                    console.log('üîç Checking data structure...');
                    console.log('data.success:', data.success);
                    console.log('data.qrCode exists:', !!data.qrCode);
                    console.log('data.qrCode.base64 exists:', !!(data.qrCode && data.qrCode.base64));
                    
                    if (data.success && data.qrCode && data.qrCode.base64) {
                        console.log('‚úÖ QR code data valid, displaying image...');
                        console.log('üñºÔ∏è Base64 length:', data.qrCode.base64.length);
                        console.log('üñºÔ∏è Base64 starts with:', data.qrCode.base64.substring(0, 50));
                        
                        document.getElementById('qr-content').innerHTML = `
                            <img id="qr-image" src="${data.qrCode.base64}" alt="PAI Assistant QR Code">
                            <p>Instance: ${data.instanceId}</p>
                        `;
                        console.log('‚úÖ QR image element created');
                    } else {
                        console.log('‚ùå QR code validation failed');
                        console.log('Missing success:', !data.success);
                        console.log('Missing qrCode:', !data.qrCode);
                        console.log('Missing base64:', !(data.qrCode && data.qrCode.base64));
                        
                        document.getElementById('qr-content').innerHTML = `
                            <div class="error">No QR code available. Instance might already be connected.</div>
                            <pre style="text-align: left; background: #f8f8f8; padding: 10px; border-radius: 5px; font-size: 12px;">Response: ${JSON.stringify(data, null, 2)}</pre>
                        `;
                    }
                } else {
                    console.error('‚ùå HTTP Error:', response.status, response.statusText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('üí• Error loading QR code:', error);
                console.error('üí• Error stack:', error.stack);
                document.getElementById('qr-content').innerHTML = `
                    <div class="error">
                        <strong>Error loading QR code:</strong><br>
                        ${error.message}<br><br>
                        <strong>Alternative:</strong><br>
                        Try accessing directly: <br>
                        <a href="http://localhost:8080/instance/connect/pai-assistant" target="_blank">
                            http://localhost:8080/instance/connect/pai-assistant
                        </a><br>
                        <small>(Note: You may need to add the API key header manually)</small>
                    </div>
                `;
            }
        }

        async function checkStatus() {
            try {
                document.getElementById('status').innerHTML = 'üîÑ Checking status...';
                
                const response = await fetch('/api/pai-assistant/status');
                
                if (response.ok) {
                    const data = await response.json();
                    const connected = data.connected || data.status?.state === 'open';
                    
                    if (connected) {
                        document.getElementById('status').className = 'status connected';
                        document.getElementById('status').innerHTML = '‚úÖ PAI Assistant is connected and ready!';
                        clearInterval(checkInterval);
                        
                        // Hide QR code if connected
                        document.getElementById('qr-content').innerHTML = `
                            <div style="color: #28a745; font-size: 1.2em;">
                                üéâ Successfully Connected!<br>
                                Users can now message the PAI Assistant WhatsApp number.
                            </div>
                        `;
                    } else {
                        document.getElementById('status').className = 'status connecting';
                        document.getElementById('status').innerHTML = `‚è≥ Status: ${data.status?.state || 'Unknown'} - Waiting for connection...`;
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error checking status:', error);
                document.getElementById('status').innerHTML = `‚ùå Error checking status: ${error.message}`;
            }
        }

        // Auto-refresh status every 5 seconds
        function startStatusMonitoring() {
            checkInterval = setInterval(checkStatus, 5000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded, initializing PAI Assistant QR page...');
            console.log('üìç Current URL:', window.location.href);
            console.log('üéØ Starting initialization sequence...');
            
            loadQRCode();
            checkStatus();
            startStatusMonitoring();
        });
        
        // Also add immediate console log to verify script loads
        console.log('üìú PAI Assistant QR script loaded successfully');
        console.log('üåê User agent:', navigator.userAgent);
        
        // Try to load QR code immediately
        setTimeout(function() {
            console.log('‚è∞ Attempting immediate QR load after 1 second...');
            loadQRCode();
        }, 1000);
    </script>
</body>
</html>